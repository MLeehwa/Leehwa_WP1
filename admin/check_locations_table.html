<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Locations í…Œì´ë¸” í™•ì¸</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="config/config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6">
    <h1 class="text-3xl font-bold mb-6">Locations í…Œì´ë¸” í™•ì¸</h1>
    
    <div id="checkResult" class="mb-6">
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-blue-800">í…Œì´ë¸” í™•ì¸ ì¤‘...</p>
      </div>
    </div>
    
    <div id="sqlInstructions" class="hidden mb-6">
      <h2 class="text-xl font-semibold mb-4">SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í•„ìš”</h2>
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
        <p class="text-yellow-800 mb-2">ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì˜ SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”:</p>
        <ul class="list-disc list-inside text-yellow-800 space-y-1">
          <li><strong>í…Œì´ë¸”ì´ ì—†ëŠ” ê²½ìš°:</strong> <code class="bg-yellow-100 px-2 py-1 rounded">create_locations_table.sql</code></li>
          <li><strong>í…Œì´ë¸”ì€ ìˆì§€ë§Œ ì»¬ëŸ¼ì´ ì—†ëŠ” ê²½ìš°:</strong> <code class="bg-yellow-100 px-2 py-1 rounded">add_columns_to_existing_table.sql</code></li>
        </ul>
      </div>
      
      <div class="bg-gray-50 border rounded-lg p-4">
        <h3 class="font-semibold mb-2">SQL íŒŒì¼ ìœ„ì¹˜:</h3>
        <ul class="list-disc list-inside text-gray-700 space-y-1">
          <li><code>admin/sql/create_locations_table.sql</code></li>
          <li><code>admin/sql/add_columns_to_existing_table.sql</code></li>
        </ul>
      </div>
    </div>
    
    <button 
      id="checkBtn" 
      class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
      onclick="checkTable()">
      ë‹¤ì‹œ í™•ì¸
    </button>
  </div>
  
  <script>
    async function checkTable() {
      const resultDiv = document.getElementById('checkResult');
      const sqlInstructions = document.getElementById('sqlInstructions');
      const checkBtn = document.getElementById('checkBtn');
      
      checkBtn.disabled = true;
      resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4"><p class="text-blue-800">í™•ì¸ ì¤‘...</p></div>';
      sqlInstructions.classList.add('hidden');
      
      try {
        // 1. í…Œì´ë¸” ì¡´ì¬ í™•ì¸
        const { data: tableCheck, error: tableError } = await window.supabase
          .from('wp1_locations')
          .select('*')
          .limit(1);
        
        if (tableError) {
          if (tableError.code === '42P01' || tableError.message.includes('does not exist')) {
            resultDiv.innerHTML = `
              <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="text-red-800 font-semibold mb-2">âŒ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</h3>
                <p class="text-red-700">wp1_locations í…Œì´ë¸”ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.</p>
              </div>
            `;
            sqlInstructions.classList.remove('hidden');
            return;
          } else {
            throw tableError;
          }
        }
        
        // 2. ì»¬ëŸ¼ í™•ì¸
        const { data: sampleData, error: sampleError } = await window.supabase
          .from('wp1_locations')
          .select('location_code, status, x, y, width, height, remark')
          .limit(1);
        
        if (sampleError) {
          // ì»¬ëŸ¼ì´ ì—†ëŠ” ê²½ìš°
          if (sampleError.message.includes('column') && sampleError.message.includes('does not exist')) {
            resultDiv.innerHTML = `
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="text-yellow-800 font-semibold mb-2">âš ï¸ í…Œì´ë¸”ì€ ì¡´ì¬í•˜ì§€ë§Œ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p class="text-yellow-700">í•„ìš”í•œ ì»¬ëŸ¼(x, y, width, height)ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.</p>
              </div>
            `;
            sqlInstructions.classList.remove('hidden');
            return;
          } else {
            throw sampleError;
          }
        }
        
        // 3. í…Œì´ë¸” êµ¬ì¡° í™•ì¸
        const { data: allColumns, error: columnsError } = await window.supabase
          .from('wp1_locations')
          .select('*')
          .limit(0);
        
        // 4. ë°ì´í„° ê°œìˆ˜ í™•ì¸
        const { count } = await window.supabase
          .from('wp1_locations')
          .select('*', { count: 'exact', head: true });
        
        resultDiv.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 class="text-green-800 font-semibold mb-2">âœ… í…Œì´ë¸”ì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</h3>
            <div class="mt-2 space-y-1 text-green-700">
              <p>â€¢ í…Œì´ë¸”: <strong>wp1_locations</strong></p>
              <p>â€¢ ë“±ë¡ëœ ìœ„ì¹˜: <strong>${count || 0}ê°œ</strong></p>
              <p>â€¢ í•„ìš”í•œ ì»¬ëŸ¼ì´ ëª¨ë‘ ì¡´ì¬í•©ë‹ˆë‹¤</p>
            </div>
            ${count === 0 ? '<p class="mt-3 text-green-600">ğŸ’¡ ìœ„ì¹˜ ë°ì´í„°ë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ë ¤ë©´ <a href="migrate_locations.html" class="underline font-semibold">ì—¬ê¸°</a>ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>' : ''}
          </div>
        `;
        
      } catch (error) {
        console.error('í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
        resultDiv.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h3 class="text-red-800 font-semibold mb-2">âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
            <p class="text-red-700">${error.message}</p>
            <p class="text-red-600 text-sm mt-2">ì½”ë“œ: ${error.code || 'N/A'}</p>
          </div>
        `;
      } finally {
        checkBtn.disabled = false;
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í™•ì¸
    window.addEventListener('load', () => {
      if (window.supabase) {
        checkTable();
      } else {
        document.getElementById('checkResult').innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-800">Supabaseê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</p>
          </div>
        `;
      }
    });
  </script>
</body>
</html>
